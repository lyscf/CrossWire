# ARPä¼ è¾“å±‚åŠ å¯†æ¶æ„è¯´æ˜

> CrossWireé¡¹ç›®çš„åˆ†å±‚åŠ å¯†è®¾è®¡

---

## ğŸ” åŠ å¯†æ¶æ„æ¦‚è§ˆ

CrossWireé‡‡ç”¨**åˆ†å±‚åŠ å¯†**è®¾è®¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨å±‚ (Client/Server)              â”‚
â”‚  - æ„é€ ä¸šåŠ¡æ¶ˆæ¯ (JSON)                       â”‚
â”‚  - ä½¿ç”¨ crypto.EncryptMessage() åŠ å¯†         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         [AES-256-GCMåŠ å¯†åçš„æ•°æ®]
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¼ è¾“å±‚ (ARP/mDNS/HTTPS)            â”‚
â”‚  - æ¥æ”¶å·²åŠ å¯†çš„ Payload                      â”‚
â”‚  - æ·»åŠ ä¼ è¾“å±‚ç­¾å (Ed25519)                  â”‚
â”‚  - åˆ†å—ã€å‘é€ã€æ¥æ”¶ã€é‡ç»„                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         [ç½‘ç»œä¼ è¾“ - ä»¥å¤ªç½‘å¸§]
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¼ è¾“å±‚ (æ¥æ”¶ç«¯)                     â”‚
â”‚  - æ¥æ”¶ã€é‡ç»„ã€éªŒè¯ç­¾å                       â”‚
â”‚  - è¿”å›å·²åŠ å¯†çš„ Payload                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
         [AES-256-GCMåŠ å¯†åçš„æ•°æ®]
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         åº”ç”¨å±‚ (Client/Server)              â”‚
â”‚  - ä½¿ç”¨ crypto.DecryptMessage() è§£å¯†         â”‚
â”‚  - è§£æä¸šåŠ¡æ¶ˆæ¯ (JSON)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ åŠ å¯†å®ç°ä½ç½®

### 1. **AES-256-GCMåŠ å¯†** (`internal/crypto/crypto.go`)

**å®ç°ä½ç½®:** Lines 30-83

#### åŠ å¯†æ–¹æ³•

```go
func (m *Manager) AESEncrypt(plaintext, key []byte) ([]byte, error) {
    // 1. ä½¿ç”¨32å­—èŠ‚å¯†é’¥åˆ›å»ºAES cipher
    block, err := aes.NewCipher(key)  // AES-256
    
    // 2. åˆ›å»ºGCMæ¨¡å¼ï¼ˆè®¤è¯åŠ å¯†ï¼‰
    gcm, err := cipher.NewGCM(block)
    
    // 3. ç”Ÿæˆéšæœºnonce
    nonce := make([]byte, gcm.NonceSize())  // 12å­—èŠ‚
    io.ReadFull(rand.Reader, nonce)
    
    // 4. åŠ å¯†å¹¶é™„åŠ è®¤è¯æ ‡ç­¾
    ciphertext := gcm.Seal(nonce, nonce, plaintext, nil)
    
    return ciphertext, nil  // [nonce][å¯†æ–‡+è®¤è¯æ ‡ç­¾]
}
```

**æ ¼å¼:**
```
[12 bytes Nonce][N bytes Ciphertext + 16 bytes Auth Tag]
```

#### è§£å¯†æ–¹æ³•

```go
func (m *Manager) AESDecrypt(ciphertext, key []byte) ([]byte, error) {
    // 1. åˆ›å»ºAES cipher
    block, err := aes.NewCipher(key)
    gcm, err := cipher.NewGCM(block)
    
    // 2. æå–nonce
    nonceSize := gcm.NonceSize()  // 12
    nonce := ciphertext[:nonceSize]
    ciphertext := ciphertext[nonceSize:]
    
    // 3. è§£å¯†å¹¶éªŒè¯è®¤è¯æ ‡ç­¾
    plaintext, err := gcm.Open(nil, nonce, ciphertext, nil)
    
    return plaintext, nil
}
```

---

### 2. **é¢‘é“å¯†é’¥ç®¡ç†** (`internal/crypto/crypto.go`)

**åŒ…è£…æ–¹æ³•:**

```go
// EncryptMessage ä½¿ç”¨é¢‘é“å¯†é’¥åŠ å¯†æ¶ˆæ¯
func (m *Manager) EncryptMessage(plaintext []byte) ([]byte, error) {
    if m.channelKey == nil {
        return nil, fmt.Errorf("channel key not set")
    }
    return m.AESEncrypt(plaintext, m.channelKey)
}

// DecryptMessage ä½¿ç”¨é¢‘é“å¯†é’¥è§£å¯†æ¶ˆæ¯
func (m *Manager) DecryptMessage(ciphertext []byte) ([]byte, error) {
    if m.channelKey == nil {
        return nil, fmt.Errorf("channel key not set")
    }
    return m.AESDecrypt(ciphertext, m.channelKey)
}
```

**é¢‘é“å¯†é’¥æ´¾ç”Ÿ:**

```go
// DeriveKey ä»å¯†ç æ´¾ç”Ÿå¯†é’¥ï¼ˆPBKDF2ï¼‰
func (m *Manager) DeriveKey(password string, salt []byte) ([]byte, error) {
    return pbkdf2.Key(
        []byte(password),
        salt,
        100000,  // è¿­ä»£æ¬¡æ•°
        32,      // 32å­—èŠ‚ = AES-256
        sha256.New,
    ), nil
}
```

---

### 3. **åº”ç”¨å±‚åŠ å¯†è°ƒç”¨**

#### å®¢æˆ·ç«¯å‘é€ (`internal/client/client.go`)

**ç¤ºä¾‹: å‘é€æ¶ˆæ¯**

```go
// Line 586-610
func (c *Client) SendMessageToChannel(...) error {
    // 1. æ„é€ æ¶ˆæ¯
    msg := &models.Message{...}
    msgJSON, _ := json.Marshal(msg)
    
    // 2. ç­¾åæ¶ˆæ¯
    signature := ed25519.Sign(c.privateKey, msgJSON)
    signedMsg := &SignedMessage{
        Message:   msgJSON,
        Signature: signature,
        SenderID:  c.memberID,
    }
    signedJSON, _ := json.Marshal(signedMsg)
    
    // 3. AESåŠ å¯† âœ…
    encrypted, err := c.crypto.EncryptMessage(signedJSON)
    
    // 4. å‘é€åˆ°ä¼ è¾“å±‚ï¼ˆå·²åŠ å¯†ï¼‰
    transportMsg := &transport.Message{
        Type:    transport.MessageTypeData,
        Payload: encrypted,  // åŠ å¯†åçš„æ•°æ®
    }
    c.transport.SendMessage(transportMsg)
}
```

#### æœåŠ¡å™¨æ¥æ”¶ (`internal/server/message_router.go`)

**ç¤ºä¾‹: å¤„ç†å®¢æˆ·ç«¯æ¶ˆæ¯**

```go
// Line 111-140
func (mr *MessageRouter) processMessageTask(task *MessageTask) {
    // 1. AESè§£å¯† âœ…
    decrypted, err := mr.server.crypto.DecryptMessage(
        task.TransportMessage.Payload,
    )
    
    // 2. è§£æç­¾åæ¶ˆæ¯
    var signedMsg SignedMessage
    json.Unmarshal(decrypted, &signedMsg)
    
    // 3. éªŒè¯ç­¾å
    // ...
    
    // 4. è§£æä¸šåŠ¡æ¶ˆæ¯
    var msg models.Message
    json.Unmarshal(signedMsg.Message, &msg)
    
    // 5. å¤„ç†ä¸šåŠ¡é€»è¾‘
    // ...
}
```

#### æœåŠ¡å™¨å¹¿æ’­ (`internal/server/broadcast_manager.go`)

**ç¤ºä¾‹: å¹¿æ’­æ¶ˆæ¯**

```go
// Line 127-145
func (bm *BroadcastManager) Broadcast(msg *models.Message) error {
    // 1. åºåˆ—åŒ–æ¶ˆæ¯
    messageData, _ := json.Marshal(msg)
    
    // 2. AESåŠ å¯† âœ…
    encryptedData, err := bm.server.crypto.EncryptMessage(messageData)
    
    // 3. æœåŠ¡å™¨ç­¾å
    signature := ed25519.Sign(
        bm.server.config.PrivateKey,
        encryptedData,
    )
    signedPayload := &transport.SignedPayload{
        Message:   encryptedData,  // åŠ å¯†åçš„æ•°æ®
        Signature: signature,
        Timestamp: time.Now().UnixNano(),
    }
    
    // 4. å‘é€åˆ°ä¼ è¾“å±‚ï¼ˆå·²åŠ å¯†+ç­¾åï¼‰
    bm.server.transport.SendMessage(&transport.Message{
        Payload: signedPayload,
    })
}
```

---

### 4. **ä¼ è¾“å±‚å¤„ç†** (`internal/transport/arp_transport.go`)

**ARPä¼ è¾“å±‚çš„è§’è‰²:**

```go
// âœ… ARPä¼ è¾“å±‚åªè´Ÿè´£ï¼š
// 1. æ¥æ”¶å·²åŠ å¯†çš„ Payload
// 2. æ·»åŠ Ed25519ç­¾åï¼ˆæœåŠ¡å™¨æ¨¡å¼ï¼‰
// 3. åˆ†å—ä¼ è¾“
// 4. æ¥æ”¶å’Œé‡ç»„
// 5. éªŒè¯Ed25519ç­¾åï¼ˆå®¢æˆ·ç«¯æ¨¡å¼ï¼‰
// 6. è¿”å›å·²åŠ å¯†çš„ Payload ç»™ä¸Šå±‚

// âŒ ARPä¼ è¾“å±‚ä¸è´Ÿè´£ï¼š
// - AESåŠ å¯†/è§£å¯†ï¼ˆç”±ä¸Šå±‚crypto.Managerå¤„ç†ï¼‰
// - ä¸šåŠ¡é€»è¾‘å¤„ç†
```

**æœåŠ¡å™¨å‘é€æµç¨‹:**

```go
// Line 461-508
func (t *ARPTransport) signAndBroadcast(msg *Message) error {
    // msg.Payload å·²ç»æ˜¯åŠ å¯†åçš„æ•°æ®ï¼
    
    // 1. ä½¿ç”¨Ed25519ç­¾åï¼ˆä¼ è¾“å±‚ç­¾åï¼‰
    signature := ed25519.Sign(
        ed25519.PrivateKey(t.serverPrivKey),
        msg.Payload,  // ç­¾åçš„æ˜¯å·²åŠ å¯†çš„æ•°æ®
    )
    
    // 2. æ„é€ ç­¾åè½½è·
    signedPayload := &SignedPayload{
        Message:   msg.Payload,  // å·²åŠ å¯†
        Signature: signature,
        Timestamp: time.Now().UnixNano(),
    }
    
    // 3. åºåˆ—åŒ–å¹¶åˆ†å—å‘é€
    // ...
}
```

**å®¢æˆ·ç«¯æ¥æ”¶æµç¨‹:**

```go
// Line 600-663
func (t *ARPTransport) handleFrame(frame *ARPFrame) {
    // å®¢æˆ·ç«¯æ¨¡å¼
    if t.mode == "client" {
        // 1. éªŒè¯Ed25519ç­¾åï¼ˆä¼ è¾“å±‚ç­¾åï¼‰
        if !ed25519.Verify(
            ed25519.PublicKey(t.serverPubKey),
            signedPayload.Message,
            signedPayload.Signature,
        ) {
            return  // ç­¾åæ— æ•ˆ
        }
        
        // 2. æ„é€ æ¶ˆæ¯ï¼ˆPayloadä»æ˜¯åŠ å¯†çš„ï¼‰
        msg := &Message{
            Payload: signedPayload.Message,  // ä»æ˜¯åŠ å¯†çŠ¶æ€
        }
        
        // 3. å›è°ƒä¸Šå±‚å¤„ç†ï¼ˆä¸Šå±‚ä¼šè§£å¯†ï¼‰
        t.handler(msg)
    }
}
```

---

## ğŸ”‘ å¯†é’¥ä½“ç³»

### å¯†é’¥ç±»å‹

| å¯†é’¥ç±»å‹ | ç®—æ³• | ç”¨é€” | ä½œç”¨åŸŸ |
|---------|------|------|-------|
| **é¢‘é“å¯†é’¥** | AES-256 | æ¶ˆæ¯åŠ å¯† | æ‰€æœ‰é¢‘é“æˆå‘˜å…±äº« |
| **æœåŠ¡å™¨ç­¾åå¯†é’¥** | Ed25519 | å¹¿æ’­æ¶ˆæ¯ç­¾å | æœåŠ¡å™¨ç§é’¥ |
| **å®¢æˆ·ç«¯ç­¾åå¯†é’¥** | Ed25519 | ç”¨æˆ·æ¶ˆæ¯ç­¾å | æ¯ä¸ªå®¢æˆ·ç«¯ç§é’¥ |

### å¯†é’¥æ´¾ç”Ÿæµç¨‹

```
é¢‘é“å¯†ç  (ç”¨æˆ·è¾“å…¥)
     â†“
 PBKDF2-SHA256 (100,000 iterations)
     â†“
é¢‘é“å¯†é’¥ (32 bytes = AES-256)
     â†“
crypto.SetChannelKey()
     â†“
ç”¨äºæ‰€æœ‰æ¶ˆæ¯çš„åŠ å¯†/è§£å¯†
```

**ä»£ç ç¤ºä¾‹:**

```go
// internal/server/server.go: Lines 194-201
cryptoManager, _ := crypto.NewManager()

// ä»å¯†ç æ´¾ç”Ÿé¢‘é“å¯†é’¥
channelKey, _ := cryptoManager.DeriveKey(
    config.ChannelPassword,  // ç”¨æˆ·å¯†ç 
    []byte(config.ChannelID), // ç›å€¼ï¼ˆé¢‘é“IDï¼‰
)

cryptoManager.SetChannelKey(channelKey)
```

---

## ğŸ”’ åŒé‡ä¿æŠ¤æœºåˆ¶

CrossWireå®ç°äº†**åŒé‡ä¿æŠ¤**ï¼š

### 1ï¸âƒ£ AES-256-GCMåŠ å¯†ï¼ˆåº”ç”¨å±‚ï¼‰

**ä¿æŠ¤ç›®æ ‡:** æ¶ˆæ¯å†…å®¹æœºå¯†æ€§å’Œå®Œæ•´æ€§

**ç‰¹ç‚¹:**
- âœ… å¯¹ç§°åŠ å¯†ï¼Œæ€§èƒ½é«˜
- âœ… GCMæ¨¡å¼æä¾›è®¤è¯ï¼Œé˜²ç¯¡æ”¹
- âœ… æ‰€æœ‰é¢‘é“æˆå‘˜å…±äº«å¯†é’¥
- âœ… å³ä½¿ä¼ è¾“å±‚è¢«ç›‘å¬ï¼Œæ¶ˆæ¯å†…å®¹ä¹Ÿæ— æ³•è¯»å–

### 2ï¸âƒ£ Ed25519ç­¾åï¼ˆä¼ è¾“å±‚ï¼‰

**ä¿æŠ¤ç›®æ ‡:** æ¶ˆæ¯æ¥æºè®¤è¯

**ç‰¹ç‚¹:**
- âœ… éå¯¹ç§°ç­¾åï¼Œé˜²å†’å……
- âœ… æœåŠ¡å™¨ç­¾åæ‰€æœ‰å¹¿æ’­æ¶ˆæ¯
- âœ… å®¢æˆ·ç«¯éªŒè¯æ¶ˆæ¯æ¥è‡ªçœŸå®æœåŠ¡å™¨
- âœ… é˜²æ­¢ä¸­é—´äººæ”»å‡»

---

## ğŸ¯ ä¸ºä»€ä¹ˆåˆ†å±‚ï¼Ÿ

### ä¼˜åŠ¿

1. **èŒè´£åˆ†ç¦»**
   - åº”ç”¨å±‚ï¼šå¤„ç†ä¸šåŠ¡é€»è¾‘å’ŒåŠ å¯†
   - ä¼ è¾“å±‚ï¼šåªè´Ÿè´£å¯é ä¼ è¾“å’Œæ¥æºè®¤è¯

2. **çµæ´»æ€§**
   - å¯ä»¥æ›´æ¢ä¼ è¾“å±‚ï¼ˆARP/mDNS/HTTPSï¼‰è€Œä¸å½±å“åŠ å¯†
   - å¯ä»¥è°ƒæ•´åŠ å¯†ç®—æ³•è€Œä¸å½±å“ä¼ è¾“

3. **å®‰å…¨æ€§**
   - åŒé‡ä¿æŠ¤ï¼šå†…å®¹åŠ å¯† + æ¥æºç­¾å
   - å³ä½¿ä¼ è¾“å±‚ç­¾åè¢«ç ´è§£ï¼Œå†…å®¹ä»åŠ å¯†

4. **æ€§èƒ½ä¼˜åŒ–**
   - ä¼ è¾“å±‚ä¸éœ€è¦åŠ å¯†ï¼Œå‡å°‘å¼€é”€
   - ç­¾åéªŒè¯æ¯”åŠ å¯†å¿«ï¼Œå¯å¿«é€Ÿè¿‡æ»¤éæ³•æ¶ˆæ¯

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åŸå§‹æ¶ˆæ¯                                  â”‚
â”‚    {"type": "text", "content": "Hello"}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ client.SendMessage()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç­¾åæ¶ˆæ¯ (åº”ç”¨å±‚ç­¾å)                     â”‚
â”‚    {                                        â”‚
â”‚      "message": "{...}",                    â”‚
â”‚      "signature": "0x...",                  â”‚
â”‚      "sender_id": "alice"                   â”‚
â”‚    }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ crypto.EncryptMessage()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. AES-256-GCMåŠ å¯†                          â”‚
â”‚    [nonce][encrypted_data][auth_tag]        â”‚
â”‚    0x4a7b2c... (å¯†æ–‡)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ transport.SendMessage()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ä¼ è¾“å±‚å¤„ç†ï¼ˆARPï¼‰                         â”‚
â”‚    - å¹¿æ’­ç»™æœåŠ¡å™¨ï¼ˆå¯èƒ½æ˜¯å¹¿æ’­ï¼‰               â”‚
â”‚    - ä¸åšåŠ å¯†ï¼Œç›´æ¥ä¼ è¾“å¯†æ–‡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ ç½‘ç»œä¼ è¾“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æœåŠ¡å™¨æ¥æ”¶                                â”‚
â”‚    - æ¥æ”¶å¯†æ–‡                                â”‚
â”‚    - å›ACKï¼ˆå¦‚æœæ˜¯å•æ’­ï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ crypto.DecryptMessage()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. AES-256-GCMè§£å¯†                          â”‚
â”‚    {                                        â”‚
â”‚      "message": "{...}",                    â”‚
â”‚      "signature": "0x...",                  â”‚
â”‚      "sender_id": "alice"                   â”‚
â”‚    }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ éªŒè¯åº”ç”¨å±‚ç­¾å
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. è§£æä¸šåŠ¡æ¶ˆæ¯                              â”‚
â”‚    {"type": "text", "content": "Hello"}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡å™¨å¹¿æ’­æ¶ˆæ¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ä¸šåŠ¡æ¶ˆæ¯                                  â”‚
â”‚    {"type": "text", "content": "World"}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ crypto.EncryptMessage()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. AES-256-GCMåŠ å¯†                          â”‚
â”‚    0x8f3a1c... (å¯†æ–‡)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ ä¼ è¾“å±‚ç­¾å
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Ed25519ç­¾å (ä¼ è¾“å±‚)                      â”‚
â”‚    {                                        â”‚
â”‚      "message": "0x8f3a1c...",  // å¯†æ–‡     â”‚
â”‚      "signature": "0xab12...",   // ä¼ è¾“ç­¾åâ”‚
â”‚      "timestamp": 1234567890                â”‚
â”‚    }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ ARPå¹¿æ’­
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ä»¥å¤ªç½‘å¸§                                  â”‚
â”‚    DstMAC: FF:FF:FF:FF:FF:FF (å¹¿æ’­)         â”‚
â”‚    Payload: SignedPayload                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ æ‰€æœ‰å®¢æˆ·ç«¯æ¥æ”¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. å®¢æˆ·ç«¯éªŒè¯ä¼ è¾“å±‚ç­¾å                       â”‚
â”‚    - éªŒè¯Ed25519ç­¾å                         â”‚
â”‚    - éªŒè¯æ—¶é—´æˆ³ï¼ˆé˜²é‡æ”¾ï¼‰                     â”‚
â”‚    - æ£€æŸ¥å»é‡                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ æå–å¯†æ–‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. AES-256-GCMè§£å¯†                          â”‚
â”‚    {"type": "text", "content": "World"}     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ channelKeyå­—æ®µçš„ä½œç”¨

### åœ¨ARPä¼ è¾“å±‚ä¸­

```go
// Line 42
channelKey []byte // AES-256å¯†é’¥

// Line 1046
func (t *ARPTransport) SetChannelKey(key []byte) {
    t.channelKey = key
}
```

**å½“å‰çŠ¶æ€:** âš ï¸ **å·²å®šä¹‰ä½†æœªä½¿ç”¨**

### ä¸ºä»€ä¹ˆå®šä¹‰ï¼Ÿ

è¿™æ˜¯ä¸ºäº†**æœªæ¥æ‰©å±•**é¢„ç•™çš„æ¥å£ï¼š

1. **å¯é€‰çš„ä¼ è¾“å±‚åŠ å¯†**
   - å¦‚æœéœ€è¦åŒé‡åŠ å¯†ï¼ˆåº”ç”¨å±‚+ä¼ è¾“å±‚ï¼‰
   - å¯ä»¥åœ¨ä¼ è¾“å±‚å†æ¬¡åŠ å¯†Payload

2. **æ¥å£ç»Ÿä¸€**
   - æ‰€æœ‰ä¼ è¾“å±‚éƒ½æœ‰ç›¸åŒçš„æ¥å£
   - ä¾¿äºåœ¨ä¸åŒä¼ è¾“å±‚ä¹‹é—´åˆ‡æ¢

3. **çµæ´»é…ç½®**
   - å¯ä»¥é€‰æ‹©æ˜¯å¦å¯ç”¨ä¼ è¾“å±‚åŠ å¯†
   - é«˜å®‰å…¨åœºæ™¯å¯ä»¥å¯ç”¨åŒé‡åŠ å¯†

### å½“å‰å®ç°

**å®é™…ä½¿ç”¨çš„æ˜¯ä¸Šå±‚åŠ å¯†ï¼š**

```go
// âœ… å½“å‰æ¶æ„ï¼ˆæ¨èï¼‰
Client â†’ crypto.EncryptMessage() â†’ Transport â†’ Network

// âŒ å¦‚æœä½¿ç”¨ä¼ è¾“å±‚åŠ å¯†ï¼ˆåŒé‡åŠ å¯†ï¼Œå¼€é”€å¤§ï¼‰
Client â†’ crypto.EncryptMessage() â†’ Transport.Encrypt() â†’ Network
```

---

## âœ… æ€»ç»“

### AESåŠ å¯†å®ç°ä½ç½®

| å±‚çº§ | ä½ç½® | æ–¹æ³• | ä½œç”¨ |
|-----|------|------|------|
| **åŠ å¯†æ ¸å¿ƒ** | `internal/crypto/crypto.go` | `AESEncrypt/AESDecrypt` | å®ç°AES-256-GCM |
| **åŒ…è£…å±‚** | `internal/crypto/crypto.go` | `EncryptMessage/DecryptMessage` | ä½¿ç”¨é¢‘é“å¯†é’¥ |
| **åº”ç”¨å±‚** | `internal/client/client.go`<br>`internal/server/server.go` | è°ƒç”¨cryptoæ–¹æ³• | å‘é€å‰åŠ å¯†<br>æ¥æ”¶åè§£å¯† |
| **ä¼ è¾“å±‚** | `internal/transport/arp_transport.go` | ä¼ è¾“Payload | **ä¸åšåŠ å¯†**<br>åªä¼ è¾“å·²åŠ å¯†æ•°æ® |

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

âœ… **èŒè´£åˆ†ç¦»:** åº”ç”¨å±‚åŠ å¯†ï¼Œä¼ è¾“å±‚ä¼ è¾“  
âœ… **åŒé‡ä¿æŠ¤:** AESåŠ å¯† + Ed25519ç­¾å  
âœ… **ç»Ÿä¸€æ¥å£:** æ‰€æœ‰ä¼ è¾“å±‚æ¥å£ä¸€è‡´  
âœ… **é«˜æ€§èƒ½:** GCMè®¤è¯åŠ å¯†ï¼Œé¿å…åŒé‡åŠ å¯†  

---

**æ–‡æ¡£ç‰ˆæœ¬:** 1.0  
**æœ€åæ›´æ–°:** 2025-10-14  
**çŠ¶æ€:** âœ… å½“å‰å®ç°æ­£ç¡®ä¸”å®‰å…¨

