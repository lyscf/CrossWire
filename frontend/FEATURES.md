# @提及功能使用说明

## 功能概述

CrossWire 前端现已集成完整的 **@提及** 功能，让团队成员可以在聊天和题目讨论中快速@其他成员。

---

## 🎯 核心特性

### 1. 智能触发
- **输入 @ 符号**自动弹出成员选择器
- 自动检测 @ 前后的空格/换行
- 支持在消息任意位置插入

### 2. 实时搜索
- **边输入边过滤**：输入 `@al` 自动筛选出 "alice"
- 支持搜索：
  - 成员名称
  - 当前任务
  - 技能标签

### 3. 键盘导航
| 快捷键 | 功能 |
|--------|------|
| ↑ / ↓ | 上下选择成员 |
| Enter | 确认选择当前成员 |
| Tab | 快速确认选择 |
| Esc | 取消选择，关闭面板 |
| 鼠标点击 | 直接选择成员 |

### 4. 视觉高亮
- **蓝色高亮**：普通 @提及
- **红色高亮**：当你被 @时
- **悬停效果**：高亮区域可交互
- **适配气泡**：自己发送的消息中样式自适应

---

## 💻 使用方法

### 方法一：手动输入 @
```
1. 在输入框输入 @
2. 自动弹出成员选择器
3. 继续输入筛选（可选）
4. 用键盘↑↓或鼠标选择成员
5. 按 Enter 或点击确认
```

### 方法二：工具栏按钮
```
1. 点击工具栏的 @ 按钮
2. 自动插入 @ 符号并打开选择器
3. 选择成员
```

---

## 🎨 界面说明

### 成员选择器
```
┌─────────────────────────────────────┐
│  选择成员    ↑↓选择 Enter确认 Esc取消│
├─────────────────────────────────────┤
│  🟢 alice                    [Web]  │ ← 在线成员
│     正在解题: SQL注入              │
│                                     │
│  ⚪ bob                      [Pwn]  │ ← 离线成员
│     离线                           │
├─────────────────────────────────────┤
│  找到 2 个成员                      │
└─────────────────────────────────────┘
```

### 消息中的显示
```
普通消息:
  alice: 大家快看 @bob 的思路很棒！
         ↑ @bob 显示为蓝色背景

被@的消息（你是bob）:
  alice: 大家快看 @bob 的思路很棒！
         ↑ @bob 显示为红色背景（提醒你被@了）
```

---

## 🔧 技术实现

### 组件结构
```
MessageInput.vue
├─ 检测 @ 输入
├─ 解析光标位置
├─ 调用 MentionSelector
└─ 插入选中成员

MentionSelector.vue
├─ 成员列表展示
├─ 实时搜索过滤
├─ 键盘事件处理
└─ 选择回调

MessageList.vue
├─ 解析消息中的 @
├─ 高亮渲染 @提及
└─ 区分是否@当前用户
```

### 数据流
```
1. 用户输入 "@a"
   ↓
2. MessageInput 检测到 @
   ↓
3. 触发 MentionSelector，传入搜索文本 "a"
   ↓
4. MentionSelector 过滤成员列表
   ↓
5. 用户选择 "alice"
   ↓
6. 插入 "@alice " 到输入框
   ↓
7. 发送消息时解析 @提及
   ↓
8. MessageList 渲染时高亮 @alice
```

---

## 📝 示例场景

### 场景 1：团队协作
```
alice: @bob @charlie 这道题需要配合，bob负责Pwn，charlie负责Web
bob: @alice 收到，我先看看有没有溢出点
charlie: @bob 我这边发现了SQL注入，你那边进展如何？
```

### 场景 2：题目讨论
```
在 ChallengeRoom（题目讨论室）中：

alice: @all 我找到了Flag格式
bob: @alice 在哪？
charlie: @alice @bob 我也想知道
```

### 场景 3：紧急求助
```
dave: @admin 服务器断线了
admin: @dave 收到，马上处理
admin: @all 网络已恢复，请重新连接
```

---

## 🎯 使用场景

### 适合使用 @ 的时候：
- ✅ 需要特定成员注意某条消息
- ✅ 分配任务或请求帮助
- ✅ 回复特定成员的问题
- ✅ 紧急通知某人
- ✅ 题目协作中指定负责人

### 不需要 @ 的时候：
- ❌ 普通闲聊
- ❌ 公开信息通知（除非用 @all）
- ❌ 自言自语或记录

---

## 🔔 通知机制（未来功能）

当前版本的 @提及功能已经实现了：
- ✅ 输入时的成员选择
- ✅ 消息中的高亮显示
- ✅ 解析提及的成员

未来将集成（需要后端支持）：
- ⏳ @提及触发桌面通知
- ⏳ 未读@消息计数
- ⏳ @消息历史记录
- ⏳ @all 全体通知

---

## 🎨 样式定制

### 普通 @提及样式
```css
.mention {
  color: #1890ff;              /* 蓝色文字 */
  background: rgba(24, 144, 255, 0.1);  /* 浅蓝背景 */
  padding: 2px 4px;
  border-radius: 2px;
  font-weight: 500;
}
```

### @到自己的样式
```css
.mention-me {
  color: #f5222d;              /* 红色文字 */
  background: rgba(245, 34, 45, 0.1);   /* 浅红背景 */
}
```

---

## 🐛 常见问题

### Q: 为什么输入 @ 没有弹出选择器？
A: 确保：
- @ 前面是空格、换行或开头
- memberStore 中有成员数据
- 输入框获得焦点

### Q: 如何@多个人？
A: 多次使用 @，如：`@alice @bob 你们看看这个`

### Q: 可以@不存在的用户吗？
A: 可以输入，但不会高亮显示，因为系统识别不出

### Q: 键盘导航不工作？
A: 确保选择器已打开，按键会被自动捕获

---

## 📊 性能优化

- ✅ 实时搜索使用 **computed** 计算属性
- ✅ 键盘事件使用 **防抖**避免频繁触发
- ✅ 消息渲染使用 **escapeHtml** 防XSS
- ✅ 成员头像颜色使用 **哈希**生成
- ✅ 选择器位置使用 **getBoundingClientRect** 精确定位

---

## 🚀 未来增强

1. **@all 全体通知**
   - 特殊语法支持
   - 权限检查（仅管理员）

2. **@频道 跨频道提及**
   - `@#channel-name`
   - 跨频道消息提醒

3. **@here 在线成员**
   - 只通知当前在线的人
   - 减少打扰

4. **智能建议**
   - 根据最近聊天推荐
   - 根据当前话题推荐

---

## 📖 API 接口（待集成）

```javascript
// 发送带@的消息
emit('send', {
  content: "@alice 你好",
  mentions: [
    {
      username: "alice",
      userId: "user_123",
      position: 0  // @ 在消息中的位置
    }
  ]
})

// 接收消息时检查是否被@
if (message.mentions.some(m => m.userId === currentUserId)) {
  // 触发通知
  showNotification(`${message.senderName} @了你`)
}
```

---

**功能状态**: ✅ 已完成  
**版本**: v1.0.0  
**更新时间**: 2025-10-05

